sudo: required

language: python
python:
- '3.6'

services:
  - docker

env:
#  matrix:
#    - DB=sqlite3
#    - DB=mysql
  global:
    - RELEASE_NAME="coda"
    - DJANGO_APP="coursedashboards"
    - COMMIT_HASH="$(git rev-parse --short=7 HEAD)"
    - IMAGE_TAG="${RELEASE_NAME}:${COMMIT_HASH}"
    - DEPLOY_SCRIPT_BASE=https://raw.githubusercontent.com/uw-it-aca/gcp-app-deploy/master
    - secure: "wBNI7FXR5nwekVODmhLIal8rdYeh96lnV1HpsmDk+JYoPRmobfAlIHLaCrjhB3FCo8ALuatImlVdA0wMSG20jmhpVPoJUKFwdT9KuBBZE+mYzjA0hBSXBZfLU8NUBxlhnib7PD+VmafTTdePlL7+NbXAIzTCqmn+PCFNKfWuAr3JdruFH22d5MeOyjWBW3kDeHGFH88Qw1rj+3WfHgFZqrZoEgyYsXJCO3ofkKALNouJxYVjXoR+pEPYxqG6jS4v3lAW1+oGI6YXp7u/iVwKguKVFoTShCCF8NU8eUf8fS+2RrMrVuE9RlX3wJQFBurO5TJNSnQuvHn1DDZEc4zhftP5lc7Ncd3lLL+lxxi/OycuIduxfLilkheZNqcs6EnPuHEblzdYV6DtAU8lfutIhZBUfGBMvtg0wwmo0asMe+pxpNDqSBVGNQ0kduF7FxKAqJZsqXRvetu0Rqzaw2+DaUUlf0MGpM32Pv5v3CgEo4O8jDY6tQZcw5wHsB9kb34+htoQ6785+wRnuSN1kuSy0aSVGMMsxfXUVsqTzHmbhX671MNk+IpRb8zSgiFtiODr+8zmIrLI5Q8AZ18rTJEW5ij8fEChMX+ECEzP0YunDrjH4lJL3dKtoZsYA14lZ5YEPhx15HNQv2voQB0qBP5soIHJQYcBFlZQp+XQMv2d49Q="
    - secure: "DYng8apdUvEN9G1itYk6Y9LK8PGALFRI3TCSDM+H4OiQ1kSDs2LnEurBKz2MVjzJs6JXT23kybN6WAQOMcBf0Zb8JFtSD7YmS7EOhuVLwDPVtB6C4NOBp8YPLoFhLFZ8dsB/kdvFu43hmCpCF5S0Z19NOZcp9zXGyxlACB0dKxU/7j3Bti4Qn/n0kMWYetONYEY+ngBtEUT1Pvdc7BsHCfJG4jKB/GQLWukav/EvQPCm63cPn4CDpqaTxaxyXGSmAc/W/nIf6Gjnp4Lz+cRa6yx+OzQ+MdjbN5rJp94noWKFovVv3pR6uYiPbi1XfR1UY8WtDSehc27fbuieo29Q2iOmjDcpPZcmGwt51UB0kaDDpPduqa4Q1g5upG+gTwdit38B94JRodq2eUSDkf0OenI1NZphauOKq44yTXizFq9321sNRDguipQLiGJH7Z2qsCJ4jw93+NEghLz7ahaJpraJkghxx6efBdjZ9zI8QXTj9Uvy9s1cMnwjt0hArbz1Fqyf/BTxIby9vR/glPfuQyC5kZjRVRXZ/GiJtahKdfKdRtlH7gozCKnGWn1tHWFNcBTu4Nap+uqzRRqaUwRZjWkLLgE2WumRb17m0fHcXjTirdXUa3ejUreevZ1cLXlZCIQ7mpVWV3mjmPem7P3pN5/7xy9SG+gPsSfiHA6AZqQ="
    - secure: "sm7ux8Hpgb/YiToTDHXb4qT0YNZ4Kr/H/W4kNOBv+qG4BGCZJiOECM6TuN8RyybiXWUfizmiiXvA2ei4EaWm4FQIU62Hc+Qm0Q0NYUoAJe6M6+8PBRk0vpM5x6I3J+cny568xpNkvTLcw0v7TfxzsYq1mTBmMDBuLLwptpvaCOR1FkuOJksdum7uMwDuB3P4RcQnE82tR7K0bbtGOQAzmZEcYz4siw/3oRIlsJV4I4eOr1n1DMS4LYtALfmiUm2IVPuiPtvStxUkhRn7B85nboybo+Kp0lzDLycMDsFo8HK77gBK6lmy6Jq7+XoT0nme/HYxXuDNGlyVKBpCrvgS2lhmhm1RQqPzR0BY2wkolFCDuKyyGLboiU6NgzA78aicZzVYWhNgQSLAn1O064fOHRi5DD1MAgwyVXA+Y4dffv3dLtG/R0ijNAREhraTEEiWMtDMoVOUcSL+mdLWAfue0rvyu5qLz8yrdOkEWvzMB2lwocWbaPrzHPL1Ed+8JV5a1S+Nn/IBUFo0kAzG9abQpgmjTRSYW3EWyfWxuFTsW+TT1PpYyUIuh7X6ambpG55FddTxqRjQrMODT0y6bZN6WlrOqqF5tbXweM6oyLQNqq9LrZyoT4QGiq07KOyAMvJ6YwgPoOK9fvhNzuGFmaQ1LBgsz/EToYElJuK8fAKeHSU="

install:
  - docker build --target coda -t "$IMAGE_TAG" .
  - docker build -t "${IMAGE_TAG}-test" .

before_script:
#  - if [ "$DB" = "mysql" ] ; then mysql -u root -e 'create database coda'; fi
#  - if [ "$DB" = "mysql" ] ; then mysql -u root -e 'create user "coda" identified by "my_pass"'; fi
#  - if [ "$DB" = "mysql" ] ; then mysql -u root -e 'grant all on *.* to coda'; fi
  - pip install coverage
  - pip install coveralls

script:
  - docker run -u root -it -v /tmp:/coverage -e DJANGO_APP="$DJANGO_APP" -e "ENV=localdev" -e "AUTH=SAML_MOCK" "${IMAGE_TAG}-test" bash -c ". ./travis-ci/test.sh"

after_script:
  - cp /tmp/.coverage.* .
  - coverage combine
  - coveralls
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ] && [[ "$TRAVIS_BRANCH" =~ ^(develop|master)$ ]]; then
    curl -Ls ${DEPLOY_SCRIPT_BASE}/travis-ci/deploy.sh | bash;
    fi

cache:
  directories:
    - "$HOME/helm"
    - "$HOME/kubeval"
